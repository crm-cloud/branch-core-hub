

# Fix: Member Creation 422 Error

## Root Cause

Two issues are causing member creation to fail:

### Issue 1: Edge function sends empty string for member_code
Line 144 of `supabase/functions/create-member-user/index.ts` explicitly sets `member_code: ''`. Even though we updated the trigger to fire on empty strings, the service-role client bypasses triggers in some cases, and there may still be a record with `member_code = ''` causing the unique constraint violation.

**Fix:** Change `member_code: ''` to omit the field entirely (or set it to `null`), so the database trigger generates it automatically.

### Issue 2: Orphaned auth users from failed attempts
Previous failed attempts created auth users (e.g., `7dbecfed-7dd2-482d-8f5b-cf8f4d42a5b3`) but the member insert failed afterward. When retrying with the same email, the function returns 422 "email already exists." The function should handle this gracefully by reusing the existing auth user or cleaning up.

**Fix:** Instead of rejecting duplicate emails outright, check if the user already exists AND has a member record. If they have an orphaned auth account (no member record), reuse that user ID.

---

## Files to Modify

### 1. `supabase/functions/create-member-user/index.ts`

**Change 1 (line 144):** Remove `member_code` from the insert so the trigger generates it:
```typescript
// Before:
member_code: '', // Will be generated by trigger

// After: (remove the line entirely, or use null)
// member_code is omitted -- generated by DB trigger
```

**Change 2 (lines 80-89):** Instead of rejecting when email exists, check if that user already has a member record. If not, reuse the orphaned auth user:
```text
1. Look up existing auth user by email
2. If found, check if a member record exists for that user_id
3. If member exists -> return 422 "member already exists"
4. If no member record -> reuse the existing user_id (skip auth.createUser)
5. If no auth user at all -> create new user as before
```

### 2. Database cleanup (migration)
Clean up any remaining records with empty member_code:
```sql
DELETE FROM members WHERE member_code = '' AND user_id IS NOT NULL
  AND NOT EXISTS (SELECT 1 FROM memberships WHERE member_id = members.id);
```

---

## Technical Details

### Updated edge function logic (create-member-user/index.ts)

```typescript
// Line 80-106: Replace the email check block with:
const { data: existingUsers } = await supabaseAdmin.auth.admin.listUsers();
const existingUser = existingUsers?.users?.find(
  u => u.email?.toLowerCase() === email.toLowerCase()
);

let userId: string;

if (existingUser) {
  // Check if member record already exists
  const { data: existingMember } = await supabaseAdmin
    .from('members')
    .select('id')
    .eq('user_id', existingUser.id)
    .maybeSingle();

  if (existingMember) {
    return new Response(
      JSON.stringify({ error: 'A member with this email already exists', code: 'email_exists' }),
      { status: 422, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }

  // Orphaned auth user -- reuse it
  userId = existingUser.id;

  // Update their profile
  await supabaseAdmin.from('profiles').update({
    full_name: fullName,
    phone: phone || null,
    gender: gender || null,
    date_of_birth: dateOfBirth || null,
    address: address || null,
    emergency_contact_name: emergencyContactName || null,
    emergency_contact_phone: emergencyContactPhone || null,
    must_set_password: true,
  }).eq('id', userId);

  // Ensure member role exists
  await supabaseAdmin.from('user_roles')
    .upsert({ user_id: userId, role: 'member' }, { onConflict: 'user_id,role' });

} else {
  // Create new auth user
  const tempPassword = crypto.randomUUID().slice(0, 12);
  const { data: authData, error: createError } = await supabaseAdmin.auth.admin.createUser({
    email, password: tempPassword, email_confirm: true,
    user_metadata: { full_name: fullName },
  });
  if (createError) throw createError;
  userId = authData.user.id;

  // Update profile
  await supabaseAdmin.from('profiles').update({ ... }).eq('id', userId);

  // Assign role
  await supabaseAdmin.from('user_roles').insert({ user_id: userId, role: 'member' });
}

// Line 139-153: Insert member WITHOUT member_code
const { data: member, error: memberError } = await supabaseAdmin
  .from('members')
  .insert({
    user_id: userId,
    branch_id: branchId,
    // member_code omitted -- generated by trigger
    status: 'active',
    source: source || 'walk-in',
    fitness_goals: fitnessGoals || null,
    health_conditions: healthConditions || null,
    referred_by: referredBy || null,
    created_by: createdBy || callingUser.id,
  })
  .select('id, member_code')
  .single();
```

## Summary

| File | Change |
|------|--------|
| `supabase/functions/create-member-user/index.ts` | Remove `member_code: ''`, add orphaned-user reuse logic |
| Database migration | Clean up any stuck empty member_code records |

